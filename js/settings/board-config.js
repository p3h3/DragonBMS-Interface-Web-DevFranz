class bmsConfig{battCellCount;battNomCapacity;protMaxCellVoltage;protMinCellVoltage;protMaxCurrent;protMaxImbalanceCurrent;protMaxLogicTemp;protMaxPowerTemp;prechargeCurrentLimit;prechargeNomCapacity;dataloggingUpdateInterval;boardAutoStart;boardPowerOffTime;boardEnabledChannels;boardUpdateCount;protMaxReverseCurrent;cellChemistry;protSpikeSensitivity;constructor(){this.initialised=!1,[].forEach.call(document.getElementsByClassName("cell-field"),e=>{e.addEventListener("input",()=>{this.#calculatePackVoltages()})}),getId("battery-cells").addEventListener("input",()=>{this.#calculatePackVoltages()}),boardConfigBatterySelector.addEventListener("change",()=>{this.#blurAppropriateVoltageFields(),this.#setStandardBatteryValues()}),boardConfigTable.addEventListener("mousemove",()=>{this.#checkBMSConfigPlausibility()}),boardConfigTable.addEventListener("change",()=>{this.#checkBMSConfigPlausibility()})}#getCellChemistry(){var e=boardConfigBatterySelector.options[boardConfigBatterySelector.selectedIndex].value;return"li-ion"===e?1:"li-po"===e?2:"li-fe-po"===e?3:"custom-li"===e?4:"custom"===e?0:void 0}#setCellChemistry(e){0===e&&(boardConfigBatterySelector.value="custom"),1===e&&(boardConfigBatterySelector.value="li-ion"),2===e&&(boardConfigBatterySelector.value="li-po"),3===e&&(boardConfigBatterySelector.value="li-fe-po"),4===e&&(boardConfigBatterySelector.value="custom-li")}#getCurrentSpikeSensitivity(){var e=getId("spike-sensitivity-select").value;return"0"===e?0:"1"!==e&&"2"===e?2:1}#setCurrentSpikeSensitivity(e){0===e&&(getId("spike-sensitivity-select").value="0"),1===e&&(getId("spike-sensitivity-select").value="1"),2===e&&(getId("spike-sensitivity-select").value="2")}#getEnabledChannelsByte(){var e=0;return(e+=+getIdChecked("enabled-channels-1"))+2*getIdChecked("enabled-channels-2")+4*getIdChecked("enabled-channels-3")}#setEnabledChannelsByte(e){getId("enabled-channels-1").checked=1&e,getId("enabled-channels-2").checked=2&e,getId("enabled-channels-3").checked=4&e}indicateSuccess(e){boardConfigTable.classList.add("success"),setTimeout(()=>{boardConfigTable.classList.remove("success")},e)}indicateWarning(e){boardConfigTable.classList.add("warning"),setTimeout(()=>{boardConfigTable.classList.remove("warning")},e)}indicateFailure(){boardConfigTable.classList.add("fault"),setTimeout(()=>{boardConfigTable.classList.remove("fault")},2e3)}readInGUIValues(){this.initialised=!0,this.battCellCount=getIdValue("battery-cells"),this.battNomCapacity=getIdValue("battery-capacity"),fullyCustomChemistryOption.disabled||(this.cellChemistry=this.#getCellChemistry()),0===this.#getCellChemistry()?(this.protMaxCellVoltage=100*getIdValue("pack-overvoltage"),this.protMinCellVoltage=100*getIdValue("pack-undervoltage")):(this.protMaxCellVoltage=getIdValue("max-cell-voltage"),this.protMinCellVoltage=getIdValue("min-cell-voltage")),this.protMaxImbalanceCurrent=100*getIdValue("strand-max-imbalance-current"),this.protMaxCurrent=100*getIdValue("strand-max-current"),this.protMaxReverseCurrent=100*getIdValue("strand-max-reverse-current"),this.protMaxPowerTemp=getIdValue("power-max-temp"),this.protMaxLogicTemp=getIdValue("logic-max-temp"),this.prechargeCurrentLimit=0,this.prechargeNomCapacity=getIdValue("load-capacitance"),this.dataloggingUpdateInterval=1e3/getIdValue("datalogging-update-frequency"),this.boardAutoStart=getIdChecked("autostart"),this.boardPowerOffTime=getIdValue("bms-config-auto-power-off"),this.boardEnabledChannels=this.#getEnabledChannelsByte(),this.boardUpdateCount=getId("updatecount").innerHTML,boardConfigSpikeSensitivitySelector.disabled||(this.protSpikeSensitivity=this.#getCurrentSpikeSensitivity())}readInBuffer(e){var t=this.getBuffer();this.battCellCount=e.getUint8(0),this.battNomCapacity=e.getUint8(2)<<8|100*e.getUint8(1),this.protMaxCellVoltage=e.getUint8(4)<<8|e.getUint8(3),this.protMinCellVoltage=e.getUint8(6)<<8|e.getUint8(5),this.protMaxCurrent=e.getUint8(8)<<8|e.getUint8(7),this.protMaxImbalanceCurrent=e.getUint8(10)<<8|e.getUint8(9),this.protMaxLogicTemp=e.getUint8(11),this.protMaxPowerTemp=e.getUint8(12),this.prechargeCurrentLimit=e.getUint8(14)<<8|e.getUint8(13),this.prechargeNomCapacity=e.getUint8(16)<<8|e.getUint8(15),this.dataloggingUpdateInterval=e.getUint8(18)<<8|e.getUint8(17),this.boardAutoStart=e.getUint8(19),this.boardPowerOffTime=e.getUint8(21)<<8|e.getUint8(20),this.boardEnabledChannels=e.getUint8(22),this.boardUpdateCount=e.getUint8(24)<<8|e.getUint8(23),this.protMaxReverseCurrent=e.getUint8(26)<<8|e.getUint8(25);try{this.protSpikeSensitivity=e.getUint8(27)}catch(e){e.constructor===RangeError&&console.log("[bms config] fw doesn't support proSpikeSensitivity")}try{this.cellChemistry=e.getUint8(28)}catch(e){e.constructor===RangeError&&console.log("[bms config] fw doesn't support cellChemistry")}return this.initialised=!0,!arraysEqual(t,this.getBuffer())}#readInConfigObject(e){this.battCellCount=e.battCellCount,this.battNomCapacity=e.battNomCapacity,this.protMaxCellVoltage=e.protMaxCellVoltage,this.protMinCellVoltage=e.protMinCellVoltage,this.protMaxCurrent=e.protMaxCurrent,this.protMaxImbalanceCurrent=e.protMaxImbalanceCurrent,this.protMaxLogicTemp=e.protMaxLogicTemp,this.protMaxPowerTemp=e.protMaxPowerTemp,this.prechargeCurrentLimit=e.prechargeCurrentLimit,this.prechargeNomCapacity=e.prechargeNomCapacity,this.dataloggingUpdateInterval=e.dataloggingUpdateInterval,this.boardAutoStart=e.boardAutoStart,this.boardPowerOffTime=e.boardPowerOffTime,this.boardEnabledChannels=e.boardEnabledChannels,this.boardUpdateCount=e.boardUpdateCount,this.protMaxReverseCurrent=e.protMaxReverseCurrent;try{this.protSpikeSensitivity=e.protSpikeSensitivity}catch(e){e.constructor===RangeError&&console.log("[bms config] fw doesn't support proSpikeSensitivity")}try{this.cellChemistry=e.cellChemistry}catch(e){e.constructor===RangeError&&console.log("[bms config] fw doesn't support cellChemistry")}}#getConfigObject(){var e={};e.battCellCount=this.battCellCount,e.battNomCapacity=this.battNomCapacity,e.protMaxCellVoltage=this.protMaxCellVoltage,e.protMinCellVoltage=this.protMinCellVoltage,e.protMaxCurrent=this.protMaxCurrent,e.protMaxImbalanceCurrent=this.protMaxImbalanceCurrent,e.protMaxLogicTemp=this.protMaxLogicTemp,e.protMaxPowerTemp=this.protMaxPowerTemp,e.prechargeCurrentLimit=this.prechargeCurrentLimit,e.prechargeNomCapacity=this.prechargeNomCapacity,e.dataloggingUpdateInterval=this.dataloggingUpdateInterval,e.boardAutoStart=this.boardAutoStart,e.boardPowerOffTime=this.boardPowerOffTime,e.boardEnabledChannels=this.boardEnabledChannels,e.boardUpdateCount=this.boardUpdateCount,e.protMaxReverseCurrent=this.protMaxReverseCurrent;try{e.protSpikeSensitivity=this.protSpikeSensitivity}catch(e){e.constructor===RangeError&&console.log("[bms config] fw doesn't support proSpikeSensitivity")}try{e.cellChemistry=this.cellChemistry}catch(e){e.constructor===RangeError&&console.log("[bms config] fw doesn't support cellChemistry")}return e}readInJSON(e){let t;try{t=JSON.parse(e)}catch(e){console.log("[config] unable to read in JSON: "+e)}void 0!==t&&this.#readInConfigObject(t)}getJSON(){if(this.initialised)return JSON.stringify(this.#getConfigObject())}getBuffer(){if(this.initialised){var e=[];e[0]=parseInt(this.battCellCount),e[1]=to16bit(Math.round(this.battNomCapacity/100))[0],e[2]=to16bit(this.battNomCapacity/100)[1],e[3]=to16bit(this.protMaxCellVoltage)[0],e[4]=to16bit(this.protMaxCellVoltage)[1],e[5]=to16bit(this.protMinCellVoltage)[0],e[6]=to16bit(this.protMinCellVoltage)[1],e[7]=to16bit(this.protMaxCurrent)[0],e[8]=to16bit(this.protMaxCurrent)[1],e[9]=to16bit(this.protMaxImbalanceCurrent)[0],e[10]=to16bit(this.protMaxImbalanceCurrent)[1],e[11]=parseInt(this.protMaxLogicTemp),e[12]=parseInt(this.protMaxPowerTemp),e[13]=to16bit(this.prechargeCurrentLimit)[0],e[14]=to16bit(this.prechargeCurrentLimit)[1],e[15]=to16bit(this.prechargeNomCapacity)[0],e[16]=to16bit(this.prechargeNomCapacity)[1],e[17]=to16bit(this.dataloggingUpdateInterval)[0],e[18]=to16bit(this.dataloggingUpdateInterval)[1],e[19]=this.boardAutoStart?1:0,e[20]=to16bit(this.boardPowerOffTime)[0],e[21]=to16bit(this.boardPowerOffTime)[1],e[22]=parseInt(this.boardEnabledChannels),e[23]=to16bit(this.boardUpdateCount)[0],e[24]=to16bit(this.boardUpdateCount)[1],e[25]=to16bit(this.protMaxReverseCurrent)[0],e[26]=to16bit(this.protMaxReverseCurrent)[1];try{void 0===this.protSpikeSensitivity||isNaN(this.protSpikeSensitivity)?console.log("firmware doesn't support protSpikeSensitivity"):e[27]=parseInt(this.protSpikeSensitivity)}catch(e){console.log("firmware doesn't support protSpikeSensitivity")}try{void 0===this.cellChemistry||isNaN(this.cellChemistry)?console.log("firmware doesn't support cellChemistry"):e[28]=parseInt(this.cellChemistry)}catch(e){console.log("[bms config] firmware doesn't support cellChemistry")}return e}}setGUIValues(){this.initialised&&(getId("battery-cells").value=this.battCellCount,getId("battery-capacity").value=this.battNomCapacity,void 0!==this.cellChemistry?(this.#setCellChemistry(this.cellChemistry),this.#blurAppropriateVoltageFields(),0===this.cellChemistry?(getId("pack-overvoltage").value=this.protMaxCellVoltage/100,getId("pack-undervoltage").value=this.protMinCellVoltage/100):(getId("max-cell-voltage").value=this.protMaxCellVoltage,getId("min-cell-voltage").value=this.protMinCellVoltage)):(fullyCustomChemistryOption.disabled=!0,getId("max-cell-voltage").value=this.protMaxCellVoltage,getId("min-cell-voltage").value=this.protMinCellVoltage),getId("strand-max-current").value=this.protMaxCurrent/100,getId("strand-max-reverse-current").value=this.protMaxReverseCurrent/100,getId("strand-max-imbalance-current").value=this.protMaxImbalanceCurrent/100,void 0!==this.protSpikeSensitivity?(boardConfigSpikeSensitivitySelector.disabled=!1,this.#setCurrentSpikeSensitivity(this.protSpikeSensitivity)):boardConfigSpikeSensitivitySelector.disabled=!0,getId("datalogging-update-frequency").value=1e3/this.dataloggingUpdateInterval,getId("logic-max-temp").value=this.protMaxLogicTemp,getId("power-max-temp").value=this.protMaxPowerTemp,getId("load-capacitance").value=this.prechargeNomCapacity,getId("autostart").checked=this.boardAutoStart,getId("bms-config-auto-power-off").value=this.boardPowerOffTime,this.#setEnabledChannelsByte(this.boardEnabledChannels),getId("updatecount").innerHTML=this.boardUpdateCount)}#checkBMSConfigPlausibility(){setValueBacktoBoundaries("battery-cells",4,30),setValueBacktoBoundaries("battery-capacity",0,1e7),setValueBacktoBoundaries("max-cell-voltage",100,6e3),setValueBacktoBoundaries("min-cell-voltage",100,6e3),setValueBacktoBoundaries("strand-max-imbalance-current",0,100);var e=bmsCalibObj.shunt1,t=bmsCalibObj.shunt2,a=bmsCalibObj.shunt3,e=1e5/Math.max(e,t,a)-1;setValueBacktoBoundaries("strand-max-current",1,e),setValueBacktoBoundaries("strand-max-reverse-current",1,e),setValueBacktoBoundaries("power-max-temp",0,90),setValueBacktoBoundaries("logic-max-temp",0,90),setValueBacktoBoundaries("datalogging-update-frequency",1,120),setValueBacktoBoundaries("bms-config-auto-power-off",0,65534)}#blurAppropriateVoltageFields(){var e=boardConfigBatterySelector.options[boardConfigBatterySelector.selectedIndex].value;if("li-ion"===e||"li-po"===e||"li-fe-po"===e){let t=document.getElementsByClassName("pack-field");for(let e=0;e<t.length;e++)t[e].style.opacity="0.5",t[e].style.pointerEvents="none";t=document.getElementsByClassName("battery-field");for(let e=0;e<t.length;e++)t[e].style.opacity="1",t[e].style.pointerEvents="";t=document.getElementsByClassName("cell-field");for(let e=0;e<t.length;e++)t[e].style.opacity="0.5",t[e].style.pointerEvents="none"}else{{let t=document.getElementsByClassName("pack-field");for(let e=0;e<t.length;e++)t[e].style.opacity="1",t[e].style.pointerEvents="";t=document.getElementsByClassName("battery-field");for(let e=0;e<t.length;e++)t[e].style.opacity="0.5",t[e].style.pointerEvents="none";t=document.getElementsByClassName("cell-field");for(let e=0;e<t.length;e++)t[e].style.opacity="1",t[e].style.pointerEvents=""}if("custom-li"===e){let t=document.getElementsByClassName("battery-field");for(let e=0;e<t.length;e++)t[e].style.opacity="1",t[e].style.pointerEvents="";t=document.getElementsByClassName("pack-field");for(let e=0;e<t.length;e++)t[e].style.opacity="0.5",t[e].style.pointerEvents="none"}else{{let t=document.getElementsByClassName("battery-field");for(let e=0;e<t.length;e++)t[e].style.opacity="1",t[e].style.pointerEvents="";t=document.getElementsByClassName("pack-field");for(let e=0;e<t.length;e++)t[e].style.opacity="1",t[e].style.pointerEvents=""}if("custom"===e){var t=document.getElementsByClassName("battery-field");for(let e=0;e<t.length;e++)t[e].style.opacity="0.5",t[e].style.pointerEvents="none"}else{var a=document.getElementsByClassName("battery-field");for(let e=0;e<a.length;e++)a[e].style.opacity="1",a[e].style.pointerEvents=""}}}}#setStandardBatteryValues(){var e=boardConfigBatterySelector.options[boardConfigBatterySelector.selectedIndex].value;"li-ion"===e?(getId("max-cell-voltage").value="4250",getId("min-cell-voltage").value="2600",this.#calculatePackVoltages()):"li-po"===e?(getId("max-cell-voltage").value="4250",getId("min-cell-voltage").value="2500",this.#calculatePackVoltages()):"li-fe-po"===e&&(getId("max-cell-voltage").value="3500",getId("min-cell-voltage").value="2400",this.#calculatePackVoltages())}#calculatePackVoltages(){getId("pack-overvoltage").value=parseFloat(getId("battery-cells").value)*parseFloat(getId("max-cell-voltage").value)/1e3,getId("pack-undervoltage").value=parseFloat(getId("battery-cells").value)*parseFloat(getId("min-cell-voltage").value)/1e3}}function readBMSConfig(a){bmsObj.bmsConfigCharacteristic.readValue().then(e=>{bmsConfigObj.initialised&&bmsConfigObj.readInGUIValues();let t=bmsConfigObj.readInBuffer(e);bmsConfigObj.initialised||(t=!0),bmsConfigObj.setGUIValues(),updateConfigRelatedGauges(bmsConfigObj),a(!0,t)}).catch(()=>{a(!1,!1)})}getId("board-config-read").addEventListener("click",()=>{readBMSConfig((e,t)=>{e?t?bmsConfigObj.indicateSuccess(500):bmsConfigObj.indicateWarning(500):bmsConfigObj.indicateFailure()})});let bmsConfigObjBefore=new bmsConfig;function writeBoardConfig(t){0<bmsAveragingBuffer.length&&2!==bmsAveragingBuffer[0].stateMachineState&&4!==bmsAveragingBuffer[0].stateMachineState||10===t?bmsConfigObj.indicateFailure():(bmsObj.pauseDataLogging().then(),bmsConfigObj.readInGUIValues(),bmsObj.bmsConfigCharacteristic.writeValue(Uint8Array.from(bmsConfigObj.getBuffer()).buffer).then(e=>{var t;getIdValue("board-config-device-name")!==bmsObj.name&&void 0!==bmsObj.name?(t=new TextEncoder,bmsObj.deviceNameCharacteristic.writeValue(t.encode(getIdValue("board-config-device-name")).buffer).then(e=>{bmsConfigObj.indicateSuccess(3e3),console.log("successfully wrote config & updated name"),setTimeout(()=>{readBMSConfig(async(e,t)=>{e?(await bmsObj.getDeviceName(),updateBMSNameFields(bmsObj.name),t?bmsConfigObj.indicateSuccess(3e3):bmsConfigObj.indicateWarning(2e3),bmsObj.dataLoggingCharacteristic.startNotifications().then(),bmsConfigObjBefore.battCellCount!==bmsConfigObj.battCellCount&&(remainingEnergy1=0,remainingEnergy2=0,remainingEnergy3=0)):bmsConfigObj.indicateFailure(),bmsObj.unPauseDataLogging().then(),bmsConfigObjBefore.battCellCount!==bmsConfigObj.battCellCount&&(remainingEnergy1=0,remainingEnergy2=0,remainingEnergy3=0)})},200)}).catch(e=>{console.log(e),bmsConfigObj.indicateFailure()})):(console.log("successfully wrote config"),readBMSConfig((e,t)=>{e?t?bmsConfigObj.indicateSuccess(3e3):bmsConfigObj.indicateWarning(2e3):bmsConfigObj.indicateFailure(),bmsObj.unPauseDataLogging().then(),bmsConfigObjBefore.battCellCount!==bmsConfigObj.battCellCount&&(remainingEnergy1=0,remainingEnergy2=0,remainingEnergy3=0)}))}).catch(e=>{setTimeout(()=>{writeBoardConfig(t+1)},100)}))}getId("board-config-write").addEventListener("click",()=>{bmsConfigObjBefore.readInGUIValues(),writeBoardConfig(0)});