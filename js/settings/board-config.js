import sf from"../helpers/small_functions";import gui from"../gui";export default class bmsConfig extends gui{battCellCount;battNomCapacity;protMaxCellVoltage;protMinCellVoltage;protMaxCurrent;protMaxImbalanceCurrent;protMaxLogicTemp;protMaxPowerTemp;prechargeCurrentLimit;prechargeNomCapacity;dataloggingUpdateInterval;boardAutoStart;boardPowerOffTime;boardEnabledChannels;boardUpdateCount;protMaxReverseCurrent;cellChemistry;protSpikeSensitivity;packOverVoltage;packUnderVoltage;bmsObj;#bmsConfigObjBefore;constructor(t,e){super(),this.initialised=!1,this.bmsObj=t,e&&(this.#bmsConfigObjBefore=new bmsConfig(t,!1))}addEventListeners(){[].forEach.call(document.getElementsByClassName("cell-field"),t=>{t.addEventListener("input",()=>{this.#calculatePackVoltages()})}),sf.getId("battery-cells").addEventListener("input",()=>{this.#calculatePackVoltages()}),this.boardConfigBatterySelector.addEventListener("change",()=>{this.#blurAppropriateVoltageFields(),this.#setStandardBatteryValues()}),this.boardConfigTable.addEventListener("mousemove",()=>{this.#checkBMSConfigPlausibility()}),this.boardConfigTable.addEventListener("change",()=>{this.#checkBMSConfigPlausibility()}),sf.getId("board-config-read").addEventListener("click",()=>{this.readBMSConfig((t,e)=>{console.log(t),t?e?this.indicateSuccess(500):this.indicateWarning(500):this.indicateFailure()})}),sf.getId("board-config-write").addEventListener("click",()=>{this.#bmsConfigObjBefore.readInGUIValues(),this.writeBoardConfig(0)})}#getCellChemistry(){var t=this.boardConfigBatterySelector.options[this.boardConfigBatterySelector.selectedIndex].value;return"li-ion"===t?1:"li-po"===t?2:"li-fe-po"===t?3:"custom-li"===t?4:"custom"===t?0:void 0}#setCellChemistry(t){0===t&&(this.boardConfigBatterySelector.value="custom"),1===t&&(this.boardConfigBatterySelector.value="li-ion"),2===t&&(this.boardConfigBatterySelector.value="li-po"),3===t&&(this.boardConfigBatterySelector.value="li-fe-po"),4===t&&(this.boardConfigBatterySelector.value="custom-li")}#getCurrentSpikeSensitivity(){var t=sf.getId("spike-sensitivity-select").value;return"0"===t?0:"1"!==t&&"2"===t?2:1}#setCurrentSpikeSensitivity(t){0===t&&(sf.getId("spike-sensitivity-select").value="0"),1===t&&(sf.getId("spike-sensitivity-select").value="1"),2===t&&(sf.getId("spike-sensitivity-select").value="2")}#getEnabledChannelsByte(){var t=0;return(t+=+sf.getIdChecked("enabled-channels-1"))+2*sf.getIdChecked("enabled-channels-2")+4*sf.getIdChecked("enabled-channels-3")}#setEnabledChannelsByte(t){sf.getId("enabled-channels-1").checked=1&t,sf.getId("enabled-channels-2").checked=2&t,sf.getId("enabled-channels-3").checked=4&t}indicateSuccess(t){this.boardConfigTable.classList.add("success"),setTimeout(()=>{this.boardConfigTable.classList.remove("success")},t)}indicateWarning(t){this.boardConfigTable.classList.add("warning"),setTimeout(()=>{this.boardConfigTable.classList.remove("warning")},t)}indicateFailure(){this.boardConfigTable.classList.add("fault"),setTimeout(()=>{this.boardConfigTable.classList.remove("fault")},2e3)}readInGUIValues(){this.initialised=!0,this.battCellCount=sf.getIdValue("battery-cells"),this.battNomCapacity=sf.getIdValue("battery-capacity"),this.fullyCustomChemistryOption.disabled||(this.cellChemistry=this.#getCellChemistry()),0===this.#getCellChemistry()?(this.protMaxCellVoltage=100*sf.getIdValue("pack-overvoltage"),this.protMinCellVoltage=100*sf.getIdValue("pack-undervoltage")):(this.protMaxCellVoltage=sf.getIdValue("max-cell-voltage"),this.protMinCellVoltage=sf.getIdValue("min-cell-voltage")),this.protMaxImbalanceCurrent=100*sf.getIdValue("strand-max-imbalance-current"),this.protMaxCurrent=100*sf.getIdValue("strand-max-current"),this.protMaxReverseCurrent=100*sf.getIdValue("strand-max-reverse-current"),this.protMaxPowerTemp=sf.getIdValue("power-max-temp"),this.protMaxLogicTemp=sf.getIdValue("logic-max-temp"),this.prechargeCurrentLimit=0,this.prechargeNomCapacity=sf.getIdValue("load-capacitance"),this.dataloggingUpdateInterval=1e3/sf.getIdValue("datalogging-update-frequency"),this.boardAutoStart=sf.getIdChecked("autostart"),this.boardPowerOffTime=sf.getIdValue("bms-config-auto-power-off"),this.boardEnabledChannels=this.#getEnabledChannelsByte(),this.boardUpdateCount=sf.getId("updatecount").innerHTML,this.boardConfigSpikeSensitivitySelector.disabled||(this.protSpikeSensitivity=this.#getCurrentSpikeSensitivity())}readInBuffer(t){var e=this.getBuffer();this.battCellCount=t.getUint8(0),this.battNomCapacity=t.getUint8(2)<<8|100*t.getUint8(1),this.protMaxCellVoltage=t.getUint8(4)<<8|t.getUint8(3),this.protMinCellVoltage=t.getUint8(6)<<8|t.getUint8(5),this.protMaxCurrent=t.getUint8(8)<<8|t.getUint8(7),this.protMaxImbalanceCurrent=t.getUint8(10)<<8|t.getUint8(9),this.protMaxLogicTemp=t.getUint8(11),this.protMaxPowerTemp=t.getUint8(12),this.prechargeCurrentLimit=t.getUint8(14)<<8|t.getUint8(13),this.prechargeNomCapacity=t.getUint8(16)<<8|t.getUint8(15),this.dataloggingUpdateInterval=t.getUint8(18)<<8|t.getUint8(17),this.boardAutoStart=t.getUint8(19),this.boardPowerOffTime=t.getUint8(21)<<8|t.getUint8(20),this.boardEnabledChannels=t.getUint8(22),this.boardUpdateCount=t.getUint8(24)<<8|t.getUint8(23),this.protMaxReverseCurrent=t.getUint8(26)<<8|t.getUint8(25);try{this.protSpikeSensitivity=t.getUint8(27)}catch(t){t.constructor===RangeError&&console.log("[bms config] fw doesn't support proSpikeSensitivity")}try{this.cellChemistry=t.getUint8(28)}catch(t){t.constructor===RangeError&&console.log("[bms config] fw doesn't support cellChemistry")}return this.initialised=!0,!sf.arraysEqual(e,this.getBuffer())}#readInConfigObject(t){this.battCellCount=t.battCellCount,this.battNomCapacity=t.battNomCapacity,this.protMaxCellVoltage=t.protMaxCellVoltage,this.protMinCellVoltage=t.protMinCellVoltage,this.protMaxCurrent=t.protMaxCurrent,this.protMaxImbalanceCurrent=t.protMaxImbalanceCurrent,this.protMaxLogicTemp=t.protMaxLogicTemp,this.protMaxPowerTemp=t.protMaxPowerTemp,this.prechargeCurrentLimit=t.prechargeCurrentLimit,this.prechargeNomCapacity=t.prechargeNomCapacity,this.dataloggingUpdateInterval=t.dataloggingUpdateInterval,this.boardAutoStart=t.boardAutoStart,this.boardPowerOffTime=t.boardPowerOffTime,this.boardEnabledChannels=t.boardEnabledChannels,this.boardUpdateCount=t.boardUpdateCount,this.protMaxReverseCurrent=t.protMaxReverseCurrent;try{this.protSpikeSensitivity=t.protSpikeSensitivity}catch(t){t.constructor===RangeError&&console.log("[bms config] fw doesn't support proSpikeSensitivity")}try{this.cellChemistry=t.cellChemistry}catch(t){t.constructor===RangeError&&console.log("[bms config] fw doesn't support cellChemistry")}}#getConfigObject(){var t={};t.battCellCount=this.battCellCount,t.battNomCapacity=this.battNomCapacity,t.protMaxCellVoltage=this.protMaxCellVoltage,t.protMinCellVoltage=this.protMinCellVoltage,t.protMaxCurrent=this.protMaxCurrent,t.protMaxImbalanceCurrent=this.protMaxImbalanceCurrent,t.protMaxLogicTemp=this.protMaxLogicTemp,t.protMaxPowerTemp=this.protMaxPowerTemp,t.prechargeCurrentLimit=this.prechargeCurrentLimit,t.prechargeNomCapacity=this.prechargeNomCapacity,t.dataloggingUpdateInterval=this.dataloggingUpdateInterval,t.boardAutoStart=this.boardAutoStart,t.boardPowerOffTime=this.boardPowerOffTime,t.boardEnabledChannels=this.boardEnabledChannels,t.boardUpdateCount=this.boardUpdateCount,t.protMaxReverseCurrent=this.protMaxReverseCurrent;try{t.protSpikeSensitivity=this.protSpikeSensitivity}catch(t){t.constructor===RangeError&&console.log("[bms config] fw doesn't support proSpikeSensitivity")}try{t.cellChemistry=this.cellChemistry}catch(t){t.constructor===RangeError&&console.log("[bms config] fw doesn't support cellChemistry")}return t}readInJSON(t){let e;try{e=JSON.parse(t)}catch(t){console.log("[config] unable to read in JSON: "+t)}void 0!==e&&this.#readInConfigObject(e)}getJSON(){if(this.initialised)return JSON.stringify(this.#getConfigObject())}getBuffer(){if(this.initialised){var t=[];t[0]=parseInt(this.battCellCount),t[1]=sf.to16bit(Math.round(this.battNomCapacity/100))[0],t[2]=sf.to16bit(this.battNomCapacity/100)[1],t[3]=sf.to16bit(this.protMaxCellVoltage)[0],t[4]=sf.to16bit(this.protMaxCellVoltage)[1],t[5]=sf.to16bit(this.protMinCellVoltage)[0],t[6]=sf.to16bit(this.protMinCellVoltage)[1],t[7]=sf.to16bit(this.protMaxCurrent)[0],t[8]=sf.to16bit(this.protMaxCurrent)[1],t[9]=sf.to16bit(this.protMaxImbalanceCurrent)[0],t[10]=sf.to16bit(this.protMaxImbalanceCurrent)[1],t[11]=parseInt(this.protMaxLogicTemp),t[12]=parseInt(this.protMaxPowerTemp),t[13]=sf.to16bit(this.prechargeCurrentLimit)[0],t[14]=sf.to16bit(this.prechargeCurrentLimit)[1],t[15]=sf.to16bit(this.prechargeNomCapacity)[0],t[16]=sf.to16bit(this.prechargeNomCapacity)[1],t[17]=sf.to16bit(this.dataloggingUpdateInterval)[0],t[18]=sf.to16bit(this.dataloggingUpdateInterval)[1],t[19]=this.boardAutoStart?1:0,t[20]=sf.to16bit(this.boardPowerOffTime)[0],t[21]=sf.to16bit(this.boardPowerOffTime)[1],t[22]=parseInt(this.boardEnabledChannels),t[23]=sf.to16bit(this.boardUpdateCount)[0],t[24]=sf.to16bit(this.boardUpdateCount)[1],t[25]=sf.to16bit(this.protMaxReverseCurrent)[0],t[26]=sf.to16bit(this.protMaxReverseCurrent)[1];try{void 0===this.protSpikeSensitivity||isNaN(this.protSpikeSensitivity)?console.log("firmware doesn't support protSpikeSensitivity"):t[27]=parseInt(this.protSpikeSensitivity)}catch(t){console.log("firmware doesn't support protSpikeSensitivity")}try{void 0===this.cellChemistry||isNaN(this.cellChemistry)?console.log("firmware doesn't support cellChemistry"):t[28]=parseInt(this.cellChemistry)}catch(t){console.log("[bms config] firmware doesn't support cellChemistry")}return t}}setGUIValues(){this.initialised&&(sf.getId("battery-cells").value=this.battCellCount,sf.getId("battery-capacity").value=this.battNomCapacity,void 0!==this.cellChemistry?(this.#setCellChemistry(this.cellChemistry),this.#blurAppropriateVoltageFields(),0===this.cellChemistry?(this.packOverVoltage=this.protMaxCellVoltage/100,this.packUnderVoltage=this.protMinCellVoltage/100):(sf.getId("max-cell-voltage").value=this.protMaxCellVoltage,sf.getId("min-cell-voltage").value=this.protMinCellVoltage,this.packOverVoltage=this.protMaxCellVoltage*this.battCellCount/1e3,this.packUnderVoltage=this.protMinCellVoltage*this.battCellCount/1e3)):(this.fullyCustomChemistryOption.disabled=!0,sf.getId("max-cell-voltage").value=this.protMaxCellVoltage,sf.getId("min-cell-voltage").value=this.protMinCellVoltage,this.packOverVoltage=this.protMaxCellVoltage*this.battCellCount/1e3,this.packUnderVoltage=this.protMinCellVoltage*this.battCellCount/1e3),sf.getId("pack-overvoltage").value=this.packOverVoltage,sf.getId("pack-undervoltage").value=this.packUnderVoltage,sf.getId("strand-max-current").value=this.protMaxCurrent/100,sf.getId("strand-max-reverse-current").value=this.protMaxReverseCurrent/100,sf.getId("strand-max-imbalance-current").value=this.protMaxImbalanceCurrent/100,void 0!==this.protSpikeSensitivity?(this.boardConfigSpikeSensitivitySelector.disabled=!1,this.#setCurrentSpikeSensitivity(this.protSpikeSensitivity)):this.boardConfigSpikeSensitivitySelector.disabled=!0,sf.getId("datalogging-update-frequency").value=1e3/this.dataloggingUpdateInterval,sf.getId("logic-max-temp").value=this.protMaxLogicTemp,sf.getId("power-max-temp").value=this.protMaxPowerTemp,sf.getId("load-capacitance").value=this.prechargeNomCapacity,sf.getId("autostart").checked=this.boardAutoStart,sf.getId("bms-config-auto-power-off").value=this.boardPowerOffTime,this.#setEnabledChannelsByte(this.boardEnabledChannels),sf.getId("updatecount").innerHTML=this.boardUpdateCount)}#checkBMSConfigPlausibility(){sf.setValueBacktoBoundaries("battery-cells",4,30),sf.setValueBacktoBoundaries("battery-capacity",0,1e7),sf.setValueBacktoBoundaries("max-cell-voltage",100,6e3),sf.setValueBacktoBoundaries("min-cell-voltage",100,6e3),sf.setValueBacktoBoundaries("strand-max-imbalance-current",0,100);var t=this.bmsObj.bmsCalibObj.shunt1,e=this.bmsObj.bmsCalibObj.shunt2,a=this.bmsObj.bmsCalibObj.shunt3,t=1e5/Math.max(t,e,a)-1;sf.setValueBacktoBoundaries("strand-max-current",1,t),sf.setValueBacktoBoundaries("strand-max-reverse-current",1,t),sf.setValueBacktoBoundaries("power-max-temp",0,90),sf.setValueBacktoBoundaries("logic-max-temp",0,90),sf.setValueBacktoBoundaries("datalogging-update-frequency",1,120),sf.setValueBacktoBoundaries("bms-config-auto-power-off",0,65534)}#blurAppropriateVoltageFields(){var t=this.boardConfigBatterySelector.options[this.boardConfigBatterySelector.selectedIndex].value;if("li-ion"===t||"li-po"===t||"li-fe-po"===t){let e=document.getElementsByClassName("pack-field");for(let t=0;t<e.length;t++)e[t].style.opacity="0.5",e[t].style.pointerEvents="none";e=document.getElementsByClassName("battery-field");for(let t=0;t<e.length;t++)e[t].style.opacity="1",e[t].style.pointerEvents="";e=document.getElementsByClassName("cell-field");for(let t=0;t<e.length;t++)e[t].style.opacity="0.5",e[t].style.pointerEvents="none"}else{{let e=document.getElementsByClassName("pack-field");for(let t=0;t<e.length;t++)e[t].style.opacity="1",e[t].style.pointerEvents="";e=document.getElementsByClassName("battery-field");for(let t=0;t<e.length;t++)e[t].style.opacity="0.5",e[t].style.pointerEvents="none";e=document.getElementsByClassName("cell-field");for(let t=0;t<e.length;t++)e[t].style.opacity="1",e[t].style.pointerEvents=""}if("custom-li"===t){let e=document.getElementsByClassName("battery-field");for(let t=0;t<e.length;t++)e[t].style.opacity="1",e[t].style.pointerEvents="";e=document.getElementsByClassName("pack-field");for(let t=0;t<e.length;t++)e[t].style.opacity="0.5",e[t].style.pointerEvents="none"}else{{let e=document.getElementsByClassName("battery-field");for(let t=0;t<e.length;t++)e[t].style.opacity="1",e[t].style.pointerEvents="";e=document.getElementsByClassName("pack-field");for(let t=0;t<e.length;t++)e[t].style.opacity="1",e[t].style.pointerEvents=""}if("custom"===t){var e=document.getElementsByClassName("battery-field");for(let t=0;t<e.length;t++)e[t].style.opacity="0.5",e[t].style.pointerEvents="none"}else{var a=document.getElementsByClassName("battery-field");for(let t=0;t<a.length;t++)a[t].style.opacity="1",a[t].style.pointerEvents=""}}}}#setStandardBatteryValues(){var t=this.boardConfigBatterySelector.options[this.boardConfigBatterySelector.selectedIndex].value;"li-ion"===t?(sf.getId("max-cell-voltage").value="4250",sf.getId("min-cell-voltage").value="2600",this.#calculatePackVoltages()):"li-po"===t?(sf.getId("max-cell-voltage").value="4250",sf.getId("min-cell-voltage").value="2500",this.#calculatePackVoltages()):"li-fe-po"===t&&(sf.getId("max-cell-voltage").value="3500",sf.getId("min-cell-voltage").value="2400",this.#calculatePackVoltages())}#calculatePackVoltages(){sf.getId("pack-overvoltage").value=parseFloat(sf.getId("battery-cells").value)*parseFloat(sf.getId("max-cell-voltage").value)/1e3,sf.getId("pack-undervoltage").value=parseFloat(sf.getId("battery-cells").value)*parseFloat(sf.getId("min-cell-voltage").value)/1e3}readBMSConfig(a){this.bmsObj.bmsConfigCharacteristic.readValue().then(t=>{this.initialised&&this.readInGUIValues();let e=this.readInBuffer(t);this.initialised||(e=!0),this.setGUIValues(),this.updateConfigRelatedGauges(this),a(!0,e)}).catch(t=>{console.log(t),a(!1,!1)})}writeBoardConfig(e){void 0===this.bmsObj&&2!==this.bmsObj.bmsDataProcessor.stateMachineState&&4!==this.bmsObj.bmsDataProcessor.stateMachineState.stateMachineState||10===e?this.indicateFailure():(this.bmsObj.pauseDataLogging().then(),this.readInGUIValues(),this.bmsObj.bmsConfigCharacteristic.writeValue(Uint8Array.from(this.getBuffer()).buffer).then(t=>{var e;sf.getIdValue("board-config-device-name")!==this.bmsObj.name&&void 0!==this.bmsObj.name?(e=new TextEncoder,this.bmsObj.deviceNameCharacteristic.writeValue(e.encode(sf.getIdValue("board-config-device-name")).buffer).then(t=>{this.indicateSuccess(3e3),console.log("successfully wrote config & updated name"),setTimeout(()=>{this.readBMSConfig(async(t,e)=>{t?(await this.bmsObj.getDeviceName(),this.updateBMSNameFields(this.bmsObj.name),e?this.indicateSuccess(3e3):this.indicateWarning(2e3),this.bmsObj.dataLoggingCharacteristic.startNotifications().then(),this.#bmsConfigObjBefore.battCellCount,this.battCellCount):this.indicateFailure(),this.bmsObj.unPauseDataLogging().then(),this.#bmsConfigObjBefore.battCellCount,this.battCellCount})},200)}).catch(t=>{console.log(t),this.indicateFailure()})):(console.log("successfully wrote config"),this.readBMSConfig((t,e)=>{t?e?this.indicateSuccess(3e3):this.indicateWarning(2e3):this.indicateFailure(),this.bmsObj.unPauseDataLogging().then(),this.#bmsConfigObjBefore.battCellCount,this.battCellCount}))}).catch(t=>{setTimeout(()=>{this.writeBoardConfig(e+1)},100)}))}}