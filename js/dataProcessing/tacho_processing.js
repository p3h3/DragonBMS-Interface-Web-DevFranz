import gui from"../gui";import sf from"../helpers/small_functions";import tachoGatherer from"./tacho_gathering";export default class tachoDataProcessor extends gui{tachoConfigObj;tachoAveragingBuffer=[];maxInlineValueBuffer=[];usedEnergyOffset;lastInlineLoggingDataTimeStamp=Date.now();drivenDistanceOffset;constructor(e,t,a){super(),this.tachoObj=e,this.tachoConfigObj=e.tachoConfigObj,this.interfaceConfig=t,this.dataLoggingMgr=a,this.tachoGatherer=new tachoGatherer(this.tachoConfigObj),this.drivenDistanceOffset=-1}isInitialised(){return void 0===this.tachoAveragingBuffer.at(0)}processData(e){e=this.tachoGatherer.gatherData(e);if(void 0!==e){var s,n=sf.getTimeStamp(),o=sf.getMsToday(),r=(this.tachoAveragingBuffer.unshift(e),sf.deleteOlderDataPackets(this.tachoAveragingBuffer,this.interfaceConfig.maxTachoAveragingInterval),sf.averagedData(sf.getLastXSeconds(this.tachoAveragingBuffer,this.interfaceConfig.tachoDataAveragingIntervalV),1)),h=sf.averagedData(sf.getLastXSeconds(this.tachoAveragingBuffer,this.interfaceConfig.tachoDataAveragingIntervalT),1),g=(this.tachoObj.linkedBMSObj.isConnected()&&void 0!==this.tachoObj.linkedBMSObj.bmsDataProcessor.bmsAveragingBuffer.at(-1)?(g=(g=this.tachoObj.linkedBMSObj.bmsDataProcessor.bmsAveragingBuffer.at(-1)).eU1+g.eU2+g.eU3,-1===this.drivenDistanceOffset&&this.tachoObj.linkedBMSObj.isConnected()&&(this.drivenDistanceOffset=e.tripOdo/1e3,this.usedEnergyOffset=g),s=e.tripOdo/1e3-this.drivenDistanceOffset,g=(g-this.usedEnergyOffset)/3.6/s,s=Math.abs((this.tachoObj.linkedBMSObj.bmsDataProcessor.remainingEnergy1+this.tachoObj.linkedBMSObj.bmsDataProcessor.remainingEnergy2+this.tachoObj.linkedBMSObj.bmsDataProcessor.remainingEnergy3)/g),this.setEconomyGauges({whkmSession:g,range:s})):this.disableEconomyGauges(),this.tachoObj.tachoConfigObj.updatePulseCount(e.calibPulseCount),this.setInlineTempValues({motor:h.motorTemp,extern:h.integratedTemp}),this.setTachoGauges({tripOdo:e.tripOdo,vehicleOdo:e.vehicleOdo}),this.setSpeedGaugeValues(r),{time:this.lastInlineLoggingDataTimeStamp,speed:e.speed,motorTemp:e.motorTemp,integratedTemp:e.integratedTemp});this.maxInlineValueBuffer.unshift(g),sf.deleteOlderDataPackets(this.maxInlineValueBuffer,60);let t=[],a=[],i=[];this.maxInlineValueBuffer.forEach(e=>{isNaN(e.speed)||t.unshift(e.speed),isNaN(e.motorTemp)||a.unshift(e.motorTemp).toFixed(1),isNaN(e.integratedTemp)||i.unshift(e.integratedTemp).toFixed(1)}),this.setInlineMaxValues({speed:Math.max(...t),motorTemp:Math.max(...a).toFixed(1),externTemp:Math.max(...i).toFixed(1)}),this.dataLoggingMgr.dataLoggingEnabled&&this.tachoObj.isConnected()&&(s=["",o,n,"","","","","","","","","",e.speed,e.rpm,e.motorTemp,e.integratedTemp,e.tripOdo].join(";"),this.dataLoggingMgr.loggingDataBuffer.push(s))}}}