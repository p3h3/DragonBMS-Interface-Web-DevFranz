let bmsConfigObj=new bmsConfig,bmsCalibObj=new bmsCalib,bmsAveragingBuffer=[],maxValueBuffer=[],lastLoggingDataTimeStamp=Date.now(),usedEnergyOffset1=-1,usedEnergyOffset2=-1,usedEnergyOffset3=-1,remainingEnergy1=0,remainingEnergy2=0,remainingEnergy3=0,hertzSampleBuffer=[];function processData(o){o=gatherBMSData(o);if(void 0!==o){bmsAveragingBuffer.unshift(o),deleteOlderDataPackets(bmsAveragingBuffer,interfaceConfig.maxAveragingInterval);var l=averagedData(getLastXSeconds(bmsAveragingBuffer,interfaceConfig.averagingIntervalU),1),d=averagedData(getLastXSeconds(bmsAveragingBuffer,interfaceConfig.averagingIntervalI),2),h=averagedData(getLastXSeconds(bmsAveragingBuffer,interfaceConfig.averagingIntervalT),1),b=averagedData(getLastXSeconds(bmsAveragingBuffer,interfaceConfig.averagingIntervalT),4),c=averagedDataNumbers(getLastXSeconds(bmsAveragingBuffer,interfaceConfig.averagingIntervalT)),E=parseFloat(l.uOut)/1e3*(parseFloat(d.i1)+parseFloat(d.i2)+parseFloat(d.i3)),c=Math.abs(c.u1*c.i1+c.u2*c.i2+c.u3*c.i3-c.uOut*(c.i1+c.i2+c.i3));let e=parseFloat(d.i1)+parseFloat(d.i2)+parseFloat(d.i3);isNaN(e)&&(e=0),-1===usedEnergyOffset1&&(usedEnergyOffset1=o.eU1),-1===(usedEnergyOffset2=-1===usedEnergyOffset2?o.eU2:usedEnergyOffset2)&&(usedEnergyOffset2=o.eU2);var y=bmsConfigObj.battCellCount,C=bmsConfigObj.battNomCapacity;let a,n=(0===remainingEnergy1&&2.5*y<=o.u1<=4.2*y&&(O=o.u1/y,a=(O-3)/1.2,remainingEnergy1=a*(C/1e3)*(3.7*y)),0===remainingEnergy2&&2.5*y<=o.u2<=4.2*y&&(O=o.u2/y,a=(O-3)/1.2,remainingEnergy2=a*(C/1e3)*(3.7*y)),0===remainingEnergy3&&2.5*y<=o.u3<=4.2*y&&(O=o.u3/y,a=(O-3)/1.2,remainingEnergy3=a*(C/1e3)*(3.7*y)),(remainingEnergy1-(o.eU1-usedEnergyOffset1)/3600)/(C/1e3*y*3.7)*100),t=(remainingEnergy2-(o.eU2-usedEnergyOffset2)/3600)/(C/1e3*y*3.7)*100,i=(remainingEnergy3-(o.eU3-usedEnergyOffset3)/3600)/(C/1e3*y*3.7)*100,r=((o.u1<2.5*y||n<=0)&&(n=0,remainingEnergy1=0),(o.u2<2.5*y||t<=0)&&(t=0,remainingEnergy2=0),(o.u3<2.5*y||i<=0)&&(i=0,remainingEnergy3=0),100);1==(1&bmsConfigObj.boardEnabledChannels)&&n<r&&(r=n),2==(2&bmsConfigObj.boardEnabledChannels)&&t<r&&(r=t),4==(4&bmsConfigObj.boardEnabledChannels)&&i<r&&(r=i);var O=o.eU1+o.eU2+o.eU3,C={iTotal:e,pTotal:E,pLoss:c,energyUsed:{combined:O,ch1:o.eU1,ch2:o.eU2,ch3:o.eU3},soc:{ch1:n,ch2:t,ch3:i,min:r}},y={time:lastLoggingDataTimeStamp,totalAmps:e,uOut:o.uOut,pTotal:E,tShunt:o.tShunt,tPch:o.tPch};maxValueBuffer.unshift(y),deleteOlderDataPackets(maxValueBuffer,interfaceConfig.maxValueHoldOnTime);let g=[],s=[],u=[],f=[],m=[];maxValueBuffer.forEach(e=>{s.unshift(parseFloat(e.totalAmps).toFixed(1)),u.unshift(e.uOut),g.unshift(e.pTotal),m.unshift(e.tShunt),f.unshift(e.tPch)}),setBMSState(o.stateMachineState),handleTurnOnTd(o.stateMachineState),handleConfigWarningButtons(o.stateMachineState),setChannelVoltageInfo(l),setChannelCurrentInfo(d),setBMSTempValues(h),setBMSMaxValues({power:Math.max(...g).toFixed(2),maxCurrent:Math.max(...s),minCurrent:Math.min(...s),minVoltage:Math.min(...u).toFixed(2),maxVoltage:Math.max(...u).toFixed(2),shuntTemp:Math.max(...m).toFixed(1),prechargeTemp:Math.max(...f).toFixed(1)}),setBMSCalculatedValues(C),bmsCalibObj.updateActualData(b),dataLoggingEnabled&&(c=getTimeStamp(),O=getMsToday(),E=[o.packageSequenceNumber,O,c,o.u1,o.u2,o.u3,o.uOut,o.i1,o.i2,o.i3,o.tShunt,o.tPch].join(";")+";;;;;",loggingDataBuffer.push(E))}}