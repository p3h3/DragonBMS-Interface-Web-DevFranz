import gui from"../gui";import otaController from"./otaController";import sf from"../helpers/small_functions";export default class otaManager extends gui{lastSelectedFirmware;bmsController;bmsDevice;tachoDevice;updateInProgress;#prevSelectedFirmware="";constructor(e,t,a){super(),this.bmsDevice=e,this.tachoDevice=t,this.deviceInfoMgr=a,this.bmsController=new otaController(e),this.tachoController=new otaController(t),this.getAvailableBMSOTAImages().then(e=>{console.log(e),this.bmsImages=e}),this.getAvailableTachoOTAImages().then(e=>{this.tachoImages=e})}addEventListeners(){this.availableOTAImagesSelect.addEventListener("click",e=>{switch(this.deviceInfoMgr.chosenDevice){case"bms":this.displayAvailableOTAImages(this.bmsImages);break;case"tacho":this.displayAvailableOTAImages(this.tachoImages);break;default:console.log("[otaManager] no device type selected!")}if(""!==this.availableOTAImagesSelect.value&&""!==this.#prevSelectedFirmware){if(this.updateInProgress)return;if(this.availableOTAImagesSelect.value===this.lastSelectedFirmware)return;switch(this.lastSelectedFirmware=this.availableOTAImagesSelect.value,this.deviceInfoMgr.blockChooser(),this.updateOTAButton.disabled=!0,this.availableOTAImagesSelect.disabled=!0,this.otaUpdateInfoText.innerText="Downloading selected Firmware...",this.deviceInfoMgr.chosenDevice){case"bms":this.loadBMSFirmware();break;case"tacho":this.loadTachoFirmware();break;default:this.deviceInfoMgr.unblockChooser(),this.updateOTAButton.disabled=!1,this.availableOTAImagesSelect.disabled=!1}}this.#prevSelectedFirmware=this.availableOTAImagesSelect.value}),this.updateOTAButton.addEventListener("click",()=>{switch(this.deviceInfoMgr.chosenDevice){case"bms":console.log("bms selected"),this.performUpdateBMS();break;case"tacho":console.log("tacho selected"),this.performUpdateTacho()}})}performUpdateTacho(){this.updateInProgress||(this.updateOTAButton.disabled=!0,this.updateInProgress=!0,this.tachoDevice.pauseDataLogging().then(()=>{this.tachoController.startUpdateProcess(()=>{this.tachoDevice.unPauseDataLogging().then(()=>{console.log("OTA update finished!"),this.updateInProgress=!1})}).catch(()=>{this.updateInProgress=!1})}))}loadTachoFirmware(){var e="https://api.github.com/repos/Dev-Voltaic/Voltaic_Tacho/releases/tags/"+this.availableOTAImagesSelect.value;this.loadFirmware(e,this.tachoController)}loadBMSFirmware(){var e="https://api.github.com/repos/Dev-Voltaic/Voltaic_BMS/releases/tags/"+this.availableOTAImagesSelect.value;this.loadFirmware(e,this.bmsController)}loadFirmware(e,t){sf.fetchWithTimeout(e).then(e=>{e.text().then(e=>{JSON.parse(e).assets.forEach(e=>{e.name.endsWith(".bin")&&(e="https://api.codetabs.com/v1/proxy?quest="+e.browser_download_url,sf.fetchWithTimeout(e,{method:"GET",headers:{},redirect:"follow"}).then(e=>{e.blob().then(e=>{t.updateSelectedFile(e,()=>{this.deviceInfoMgr.unblockChooser(),this.updateOTAButton.disabled=!1,this.availableOTAImagesSelect.disabled=!1,this.otaUpdateInfoText.innerText="Firmware "+this.availableOTAImagesSelect.value+" downloaded!"})})}).catch(()=>{this.deviceInfoMgr.unblockChooser(),this.updateOTAButton.disabled=!1,this.availableOTAImagesSelect.disabled=!1,this.otaUpdateInfoText.innerText="Firmware download failed!"}))})})}).catch(()=>{this.deviceInfoMgr.unblockChooser(),this.updateOTAButton.disabled=!1,this.availableOTAImagesSelect.disabled=!1,this.otaUpdateInfoText.innerText="Firmware download failed!"})}performUpdateBMS(){this.updateInProgress||(this.updateOTAButton.disabled=!0,this.updateInProgress=!0,this.bmsDevice.pauseDataLogging().then(()=>{this.bmsController.startUpdateProcess(()=>{this.bmsDevice.unPauseDataLogging().then(()=>{console.log("OTA update finished!"),this.updateInProgress=!1})}).catch(()=>{this.updateInProgress=!1})}))}displayAvailableOTAImages(e){let s=!0;this.availableOTAImagesSelect.childNodes.forEach(t=>{let a=!1;e.forEach(e=>{e.tag_name===t.value&&(a=!0)}),a||(s=!1)}),s||(this.availableOTAImagesSelect.innerHTML="",e.forEach(e=>{var e=e.tag_name,t=document.createElement("option");t.value=e,t.innerHTML=e,this.availableOTAImagesSelect.appendChild(t)}))}async getAvailableTachoOTAImages(){try{var e=await sf.fetchWithTimeout("https://api.codetabs.com/v1/proxy?quest=https://api.github.com/repos/Dev-Voltaic/Voltaic_Tacho/releases");if(200===e.status)return JSON.parse(await e.text());this.availableOTAImagesSelect.innerHtml="Failed to get versions!"}catch(e){return e instanceof TypeError&&(this.availableOTAImagesSelect.innerHtml="No Internet connection!"),{}}}async getAvailableBMSOTAImages(){try{var e=await sf.fetchWithTimeout("https://api.codetabs.com/v1/proxy?quest=https://api.github.com/repos/Dev-Voltaic/Voltaic_BMS/releases");if(200===e.status)return JSON.parse(await e.text());this.availableOTAImagesSelect.innerHtml="Failed to get versions!"}catch(e){return e instanceof TypeError&&(this.availableOTAImagesSelect.innerHtml="No Internet connection!"),{}}}}