let CBOR=require("./cbor");export default class MCUManager{#MGMT_OP_READ=0;#MGMT_OP_WRITE=2;#MGMT_GROUP_ID_OS=0;#MGMT_GROUP_ID_IMAGE=1;#OS_MGMT_ID_ECHO=0;#OS_MGMT_ID_RESET=5;#IMG_MGMT_ID_STATE=0;#IMG_MGMT_ID_UPLOAD=1;#IMG_MGMT_ID_ERASE=5;#otaUpdateServiceUuid="8d53dc1d-1db7-4cd3-868b-8a527460aa84";#otaUpdateCharacteristicUuid="da2e7828-fbce-4e01-ae9e-261174997c48";#MTU=200;constructor(e){this._device=e,this._service=null,this._characteristic=null,this._connectCallback=null,this._connectingCallback=null,this._disconnectCallback=null,this._messageCallback=null,this._imageUploadProgressCallback=null,this._uploadIsInProgress=!1,this._buffer=new Uint8Array,this._logger={info:console.log,error:console.error},this._seq=0}async connect(){try{this._connectingCallback&&this._connectingCallback();var e=this._device.gattServer;this._logger.info("Server connected."),this._service=await e.getPrimaryService(this.#otaUpdateServiceUuid),this._logger.info("Service connected."),this._characteristic=await this._service.getCharacteristic(this.#otaUpdateCharacteristicUuid),this._characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),await this._characteristic.startNotifications(),await this._connected(),this._uploadIsInProgress&&await this._uploadNext()}catch(e){this._logger.error(e),await this._disconnected()}}disconnect(){return this._userRequestedDisconnect=!0,this._device.gatt.disconnect()}onConnecting(e){return this._connectingCallback=e,this}onConnect(e){return this._connectCallback=e,this}onDisconnect(e){return this._disconnectCallback=e,this}onMessage(e){return this._messageCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}async _connected(){this._connectCallback&&this._connectCallback()}async _disconnected(){this._logger.info("Disconnected."),this._disconnectCallback&&this._disconnectCallback(),this._device=null,this._service=null,this._characteristic=null,this._uploadIsInProgress=!1,this._userRequestedDisconnect=!1}get name(){return this._device&&this._device.name}async _sendMessage(e,t,s,i){let a=[];i=255&(a=void 0!==i?[...new Uint8Array(CBOR.encode(i))]:a).length,e=[e,0,a.length>>8,i,t>>8,255&t,this._seq,s,...a];await this._characteristic.writeValueWithoutResponse(Uint8Array.from(e)),this._seq=(this._seq+1)%256}_notification(e){e=new Uint8Array(e.target.value.buffer),this._buffer=new Uint8Array([...this._buffer,...e]),e=256*this._buffer[2]+this._buffer[3];this._buffer.length<e+8||(this._processMessage(this._buffer.slice(0,e+8)),this._buffer=this._buffer.slice(e+8))}_processMessage(e){var[t,,s,i,a,r,,n]=e,e=CBOR.decode(e.slice(8).buffer),s=256*s+i,i=256*a+r;i===this.#MGMT_GROUP_ID_IMAGE&&n===this.#IMG_MGMT_ID_UPLOAD&&0===e.rc&&e.off?(this._uploadOffset=e.off,this._uploadNext()):this._messageCallback&&this._messageCallback({op:t,group:i,id:n,data:e,length:s})}cmdReset(){return this._sendMessage(this.#MGMT_OP_WRITE,this.#MGMT_GROUP_ID_OS,this.#OS_MGMT_ID_RESET)}smpEcho(e){return this._sendMessage(this.#MGMT_OP_WRITE,this.#MGMT_GROUP_ID_OS,this.#OS_MGMT_ID_ECHO,{d:e})}cmdImageState(){return this._sendMessage(this.#MGMT_OP_READ,this.#MGMT_GROUP_ID_IMAGE,this.#IMG_MGMT_ID_STATE)}cmdImageErase(){return this._sendMessage(this.#MGMT_OP_WRITE,this.#MGMT_GROUP_ID_IMAGE,this.#IMG_MGMT_ID_ERASE,{})}cmdImageTest(e){return this._sendMessage(this.#MGMT_OP_WRITE,this.#MGMT_GROUP_ID_IMAGE,this.#IMG_MGMT_ID_STATE,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._sendMessage(this.#MGMT_OP_WRITE,this.#MGMT_GROUP_ID_IMAGE,this.#IMG_MGMT_ID_STATE,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){var e,t;this._uploadOffset>=this._uploadImage.byteLength?(this._uploadIsInProgress=!1,this._imageUploadFinishedCallback()):(e={data:new Uint8Array,off:this._uploadOffset},0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*1e3)/10}),t=this.#MTU-CBOR.encode(e).byteLength-8,e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t,await this.sendMessageTry(this.#MGMT_OP_WRITE,this.#MGMT_GROUP_ID_IMAGE,this.#IMG_MGMT_ID_UPLOAD,e,0))}async sendMessageTry(t,s,i,a,r){if(20<r)throw new DOMException("GATT operation failed for unknown reason");try{await this._sendMessage(t,s,i,a)}catch(e){setTimeout(async()=>{console.log("[mcumgr] error while sending message, try number "+r+" error: "+e),await this.sendMessageTry(t,s,i,a,r+1)},200)}}async cmdUpload(e,t=0){this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async imageInfo(e){var t={},s=new Uint8Array(e);if(s.length<32)throw new Error("Invalid image (too short file)");if(61!==s[0]||184!==s[1]||243!==s[2]||150!==s[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==s[4]||0!==s[5]||0!==s[6]||0!==s[7])throw new Error("Invalid image (wrong load address)");var i=s[8]+256*s[9];if(0!==s[10]||0!==s[11])throw new Error("Invalid image (wrong protected TLV area size)");var a=s[12]+256*s[13]+65536*s[14]+s[15]*2**24;if(s.length<(t.imageSize=a)+i)throw new Error("Invalid image (wrong image size)");if(0!==s[16]||0!==s[17]||0!==s[18]||0!==s[19])throw new Error("Invalid image (wrong flags)");return t.version=`${s[20]}.${s[21]}.`+(s[22]+256*s[23]),t.hash=[...new Uint8Array(await this._hash(e.slice(0,a+32)))].map(e=>e.toString(16).padStart(2,"0")).join(""),t}}